<div class="header">
    <h2>Service Requests</h2>
    <div class="filter-group">
        <label for="filter">Filter:</label>
        <select id="filter" [(ngModel)]="selectedFilter" (change)="onFilterChange()">
            <option value="ALL">All</option>
            <option value="PENDING">Pending (Requested)</option>
            <option value="ASSIGNED">Assigned</option>
            <option value="IN_PROGRESS">In Progress</option>
            <option value="COMPLETED">Completed</option>
            <option value="CLOSED">Closed</option>
        </select>
    </div>
</div>

<div class="success-message" *ngIf="successMessage">{{ successMessage }}</div>
<div class="error-message" *ngIf="errorMessage && !assignMode && !closeMode">{{ errorMessage }}</div>

<div class="card-list" *ngIf="!assignMode && !closeMode">
    <div *ngFor="let req of filteredRequests" class="card">
        <div class="card-info">
            <strong>{{ req.issueDescription }}</strong>
            <span>ID: {{ req.id }}</span>
            <span>Vehicle: {{ req.vehicleId }}</span>
            <span>Priority: {{ req.priority }}</span>
            <span *ngIf="req.technicianId">Technician: {{ req.technicianId }}</span>
        </div>
        <div class="card-actions">
            <span class="status" [ngClass]="req.status?.toLowerCase()">{{ req.status }}</span>
            <button class="btn-primary" *ngIf="req.status === 'REQUESTED'" (click)="openAssign(req)">Assign</button>
            <button class="btn-secondary" *ngIf="req.status === 'COMPLETED'" (click)="openClose(req)">Close</button>
        </div>
    </div>
    <p *ngIf="filteredRequests.length === 0" class="no-data">No service requests found.</p>
</div>

<div class="modal-panel" *ngIf="assignMode">
    <h3>Assign Service Request</h3>
    <p><strong>{{ selectedRequest?.issueDescription }}</strong></p>

    <div class="error-message" *ngIf="errorMessage">{{ errorMessage }}</div>

    <div class="form-group">
        <label for="technician">Select Technician (sorted by workload)</label>
        <select id="technician" [(ngModel)]="selectedTechnicianId">
            <option value="">-- Select --</option>
            <option *ngFor="let tech of technicians" [value]="tech.id">
                {{ tech.name }} (ID: {{ tech.id | slice:0:8 }}...) - Workload: {{ tech.workload }}
            </option>
        </select>
    </div>

    <div class="form-group">
        <label for="bay">Select Bay</label>
        <select id="bay" [(ngModel)]="selectedBayId">
            <option value="">-- Select --</option>
            <option *ngFor="let bay of bays" [value]="bay.id">{{ bay.bayCode || 'Bay' }} ({{ bay.id }})</option>
        </select>
    </div>

    <div class="button-group">
        <button class="btn-primary" (click)="assign()">Assign</button>
        <button class="btn-secondary" (click)="cancel()">Cancel</button>
    </div>
</div>

<div class="modal-panel" *ngIf="closeMode">
    <h3>Close Service Request</h3>
    <p><strong>{{ selectedRequest?.issueDescription }}</strong></p>

    <div class="error-message" *ngIf="errorMessage">{{ errorMessage }}</div>

    <div class="form-group">
        <label for="labour">Labour Charges (â‚¹)</label>
        <input type="number" id="labour" [(ngModel)]="labourCharges" min="1">
    </div>

    <div class="button-group">
        <button class="btn-primary" (click)="close()">Close Service</button>
        <button class="btn-secondary" (click)="cancel()">Cancel</button>
    </div>
</div>